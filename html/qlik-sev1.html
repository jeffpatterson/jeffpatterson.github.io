<html>
  <head>
    <title>Darwin / Qlik Stage Test</title>
  </head>
  <body>
<script>
    window.orbConfig = {
        connectionOptions: {
            gridUrl: "https://grid.meya.ai",
            appId: "app-5d25cf848e834f8699cd7a80aaada26c",
            integrationId: "integration.orb",
            connect: false,
            pageContext: {
                environment: "STAGE",
                darwinMetadata: {
                    url: document.location.href,
                    qlik_user_id: !(typeof LITHIUM === "undefined") && !(typeof LITHIUM?.CommunityJsonObject?.User?.id === "undefined") ? LITHIUM.CommunityJsonObject.User.id : "",
                    email: !(typeof LITHIUM === "undefined") && !(typeof LITHIUM?.CommunityJsonObject?.User?.emailRef === "undefined") ? LITHIUM.CommunityJsonObject.User.emailRef : ""
                }
            },
            //onFirstConnect: (connectData, next) => {
            //    orb.addListener("eventStream", onEventStream);
            //    next();
            //}
        },
        theme: {
            brandColor: "#005cb9",
            botAvatarUrl: "https://www.qlik.com/us/-/media/images/global-us/Resource-Library/Custom/driftbot_graphic_circle.jpg"
        },
        launcher: {
            type: "message",
            text: "Contact Support",
            icon: "streamline-bold/01-interface-essential/16-help/headphones-customer-support.svg"
        },
        windowApi: true,
        mediaUpload: {
            all: false, // Disable for all other current & future media types
            image: true // Enable just for images
        }
    };
    (function () {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.async = true;
        script.src = "https://cdn.meya.ai/v2/orb.js";
        document.body.appendChild(script);
        var fontStyleSheet = document.createElement("link");
        fontStyleSheet.rel = "stylesheet";
        fontStyleSheet.href = "https://cdn.meya.ai/font/inter.css";
        document.body.appendChild(fontStyleSheet);
    })();
</script>

<script>
    /* Darwin auto-open code */
    document.addEventListener("DOMContentLoaded", function() {
        
        var interval = setInterval(function() {
            if(typeof orb === "undefined") return;
            clearInterval(interval);
            orb.addListener("eventStream", onEventStream);
            var queryString = window.location.search;
            var urlParams = new URLSearchParams(queryString);

            if(urlParams.has("launchChat") || urlParams.has("sev1")) {
                orb.openChat();
            }
        }, 500);
    });
  
    var sevEventTriggered = false;
         
  
    function onEventStream(eventStream) {
        for(const event of [...eventStream.events]) {
            console.log("FOUND EVENT");
            console.log(event);
            if(event.type === "meya.lifecycle.event.event") {
                console.log(event.data.lifecycle_id);
                if(event.data.lifecycle_id === "welcomeTurnFinished" && !sevEventTriggered) {
                    try {
                        orb.say("production is down");
                        sevEventTriggered = true;
                    }
                    catch(e) {
                        console.log("CAUGHT ERROR");
                        console.log(e);
                    }
                }
            }
            break;
        }
    }
</script>
  </body>
</html>
