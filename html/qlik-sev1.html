<html>
  <head>
    <title>Darwin / Qlik Stage Test</title>
  </head>
  <body>
<script>
    window.orbConfig = {
        connectionOptions: {
            gridUrl: "https://grid.meya.ai",
            appId: "app-5d25cf848e834f8699cd7a80aaada26c",
            integrationId: "integration.orb",
            connect: false,
            pageContext: {
                environment: "DRAFT",
                darwinMetadata: {
                    url: document.location.href,
                    qlik_user_id: !(typeof LITHIUM === "undefined") && !(typeof LITHIUM?.CommunityJsonObject?.User?.id === "undefined") ? LITHIUM.CommunityJsonObject.User.id : "",
                    email: !(typeof LITHIUM === "undefined") && !(typeof LITHIUM?.CommunityJsonObject?.User?.emailRef === "undefined") ? LITHIUM.CommunityJsonObject.User.emailRef : ""
                }
            },
            //onFirstConnect: (connectData, next) => {
            //    orb.addListener("eventStream", onEventStream);
            //    next();
            //}
        },
        theme: {
            brandColor: "#005cb9",
            botAvatarUrl: "https://www.qlik.com/us/-/media/images/global-us/Resource-Library/Custom/driftbot_graphic_circle.jpg"
        },
        launcher: {
            type: "message",
            text: "Contact Support",
            icon: "streamline-bold/01-interface-essential/16-help/headphones-customer-support.svg"
        },
        windowApi: true,
        mediaUpload: {
            all: false, // Disable for all other current & future media types
            image: true // Enable just for images
        }
    };
    (function () {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.async = true;
        script.src = "https://cdn.meya.ai/v2/orb.js";
        document.body.appendChild(script);
        var fontStyleSheet = document.createElement("link");
        fontStyleSheet.rel = "stylesheet";
        fontStyleSheet.href = "https://cdn.meya.ai/font/inter.css";
        document.body.appendChild(fontStyleSheet);
    })();
</script>

<script>
    /* Darwin auto-open code */
    var triggerSev1 = false;
  
    document.addEventListener("DOMContentLoaded", function() {
        
        var interval = setInterval(function() {
            if(typeof orb === "undefined") return;
            clearInterval(interval);
          
            orb.addListener("eventStream", onEventStream);
          
            var queryString = window.location.search;
            var urlParams = new URLSearchParams(queryString);

            if(urlParams.has("launchChat")) {
                orb.openChat();
            }
            
            if(urlParams.has("sev1")) {
                let sev1triggered = darwinGetCookie("sev1triggered") ? true : false;
                let localId = window.orbConfig.connectionOptions.appId;
                let threadId = localStorage.getItem(`https://grid.meya.ai/gateway/v2/orb/${localId}/integration.orb.orbThreadId`);
              
                if (threadId && !sev1triggered) {
                    localStorage.removeItem(`https://grid.meya.ai/gateway/v2/orb/${localId}/integration.orb.orbThreadId`);
                    location.reload();
                } else if (!sev1triggered) {
                    triggerSev1 = true;
                    orb.openChat();
                } else {
                    orb.openChat();
                }
            }
        }, 500);
    });
  
    var sevEventTriggered = false;
  
    function onEventStream(eventStream) {
        for(const event of [...eventStream.events]) {
            if(event.type === "meya.lifecycle.event.event") {
                if(event.data.lifecycle_id === "welcomeTurnFinished" && triggerSev1) {
                    let sev1triggered = darwinGetCookie("setv1triggered");
                    if (!sev1triggered) {
                        orb.say("production is down");
                        sevEventTriggered = true;
                        darwinSetCookie("sev1triggered","1",2);
                    }
                }
            }
            break;
        }
    }
    
    function darwinSetCookie(name,value,minutes) {
        var expires = "";
        if (minutes) {
            var date = new Date();
            date.setTime(date.getTime() + (minutes*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    
    function darwinGetCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    
    function darwinEraseCookie(name) {   
        document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    }
</script>
  </body>
</html>
